<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>èˆ¹èˆ¶å·¥ç¨‹æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body { margin: 0; padding: 0; font-family: "Helvetica Neue",Helvetica,"PingFang SC",Arial,sans-serif; }
        .header { background-color: #409EFF; color: white; padding: 20px; font-size: 24px; font-weight: bold; }
        .container { display: flex; height: calc(100vh - 70px); }
        .aside { width: 300px; border-right: 1px solid #eee; padding: 20px; overflow-y: auto; }
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .empty-tip { color: #909399; text-align: center; margin-top: 100px; }
    </style>
</head>
<body>
<div id="app">
    <div class="header">ğŸš¢ èˆ¹èˆ¶å·¥ç¨‹æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ (NoSQL Demo)</div>
    <div class="container">
        <div class="aside">
            <h3>ğŸ› ï¸ èˆ¹èˆ¶ç»“æ„æ ‘ (BOM)</h3>
            <el-button size="mini" type="success" @click="initTree" style="margin-bottom: 10px;">åˆ·æ–°/é‡ç½®æ ‘</el-button>
            <el-tree
                    :data="treeData"
                    :props="defaultProps"
                    @node-click="handleNodeClick"
                    default-expand-all
                    highlight-current>
            </el-tree>
        </div>

        <div class="main">
            <div v-if="currentPart">
                <h2>
                    {{ currentPart.name }}
                    <el-tag size="small">{{ currentPart.type }}</el-tag>
                    <el-button type="danger" size="small" style="float: right" @click="deletePart">åˆ é™¤æ­¤èŠ‚ç‚¹</el-button>
                </h2>

                <el-descriptions title="æŠ€æœ¯å‚æ•° (MongoDB Specs)" border v-if="currentPart.specs">
                    <el-descriptions-item v-for="(val, key) in currentPart.specs" :label="key">{{ val }}</el-descriptions-item>
                </el-descriptions>
                <div v-else style="color: #ccc; margin: 10px 0;">æš‚æ— æŠ€æœ¯å‚æ•°</div>

                <el-divider></el-divider>

                <h3>ğŸ“„ å…³è”æ–‡æ¡£</h3>
                <div style="margin-bottom: 15px;">
                    <input type="file" ref="fileInput" style="display: none" @change="uploadFile">
                    <el-button type="primary" size="small" icon="el-icon-upload" @click="$refs.fileInput.click()">ä¸Šä¼ æ–‡æ¡£</el-button>
                </div>

                <el-table :data="docList" style="width: 100%" border>
                    <el-table-column prop="id" label="ID" width="50"></el-table-column>
                    <el-table-column prop="title" label="æ–‡æ¡£æ ‡é¢˜"></el-table-column>
                    <el-table-column prop="category" label="åˆ†ç±»" width="100"></el-table-column>
                    <el-table-column prop="createdAt" label="ä¸Šä¼ æ—¶é—´"></el-table-column>
                    <el-table-column label="æ“ä½œ" width="150">
                        <template slot-scope="scope">
                            <el-button size="mini" type="primary" @click="viewDetail(scope.row.id)">é¢„è§ˆ/ä¸‹è½½</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>

            <div v-else class="empty-tip">
                ğŸ‘ˆ è¯·åœ¨å·¦ä¾§ç‚¹å‡»ä¸€ä¸ªé›¶ä»¶æŸ¥çœ‹è¯¦æƒ…
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            treeData: [],
            defaultProps: { children: 'children', label: 'name' },
            currentPart: null,
            docList: [],
            shipId: 1001 // è¿™é‡Œå…ˆå†™æ­»ï¼Œæˆ–è€…ä» tree æ¥å£åŠ¨æ€è·å–
        },
        mounted() {
            this.loadTree();
        },
        methods: {
            // 1. åŠ è½½æ ‘ (è°ƒç”¨ä½ çš„åç«¯æ¥å£)
            loadTree() {
                // å¦‚æœä½ çš„æµ‹è¯•æ¥å£è·¯å¾„æ˜¯ /test/treeï¼Œè¿™é‡Œç›´æ¥ç”¨
                // å®é™…å»ºè®®ä½ æŠŠé€ æ ‘é€»è¾‘ç‹¬ç«‹å‡ºæ¥ï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ç›´æ¥è°ƒ
                axios.get('/test/tree').then(res => {
                    this.treeData = res.data;
                    // ç®€å•çš„æŠŠ shipId ä¿®æ­£ä¸ºæ ¹èŠ‚ç‚¹çš„ ID (å¦‚æœéœ€è¦)
                    if(this.treeData.length > 0) {
                        // å‡è®¾åç«¯è¿”å›çš„æ˜¯ä¸ªåˆ—è¡¨ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ ¹
                        // console.log(res.data);
                    }
                });
            },
            // 2. åˆ·æ–°é‡ç½® (è°ƒç”¨ä½ çš„é€ æ•°æ®æ¥å£)
            initTree() {
                this.$confirm('ç¡®å®šè¦é‡ç½®å¹¶ç”Ÿæˆæ–°æ ‘å—ï¼Ÿ', 'æç¤º').then(() => {
                    axios.get('/test/tree').then(res => {
                        this.treeData = res.data;
                        this.$message.success('æ ‘ç»“æ„å·²åˆ·æ–°');
                    });
                });
            },
            // 3. ç‚¹å‡»èŠ‚ç‚¹
            handleNodeClick(data) {
                this.currentPart = data; // data å°±æ˜¯ ComponentDoc çš„æ•°æ®
                this.loadDocs(data.id);
            },
            // 4. åŠ è½½æ–‡æ¡£åˆ—è¡¨
            loadDocs(componentId) {
                // è°ƒç”¨åç«¯ /api/docs/list
                // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ä½ çš„ shipId æ˜¯å›ºå®šçš„æˆ–è€…ä»æ ¹èŠ‚ç‚¹å–çš„
                axios.get(`/api/docs/list?shipId=888&componentId=${componentId}`)
                    .then(res => {
                        this.docList = res.data;
                    });
            },
            // 5. ä¸Šä¼ æ–‡ä»¶
            uploadFile(event) {
                let file = event.target.files[0];
                if(!file) return;

                let formData = new FormData();
                formData.append('file', file);
                formData.append('shipId', 888); // ä¿æŒä¸€è‡´
                formData.append('componentId', this.currentPart.id);
                formData.append('title', file.name); // ç®€å•ç”¨æ–‡ä»¶åå½“æ ‡é¢˜
                formData.append('category', 'AutoUpload');

                axios.post('/api/docs/upload', formData).then(res => {
                    this.$message.success('ä¸Šä¼ æˆåŠŸ');
                    this.loadDocs(this.currentPart.id); // åˆ·æ–°åˆ—è¡¨
                }).catch(err => {
                    this.$message.error('ä¸Šä¼ å¤±è´¥');
                });
            },
            // 6. æŸ¥çœ‹/ä¸‹è½½
            viewDetail(id) {
                axios.get(`/api/docs/${id}`).then(res => {
                    let versions = res.data.versions;
                    if(versions && versions.length > 0) {
                        // ç›´æ¥æ‰“å¼€æœ€æ–°ç‰ˆæœ¬çš„ URL
                        let url = versions[0].downloadUrl;
                        window.open(url, '_blank');
                    } else {
                        this.$message.warning('è¯¥æ–‡æ¡£æ²¡æœ‰æ–‡ä»¶');
                    }
                });
            },
            // 7. åˆ é™¤èŠ‚ç‚¹
            deletePart() {
                this.$confirm(`ç¡®å®šè¦åˆ é™¤ [${this.currentPart.name}] åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹å’Œæ–‡æ¡£å—ï¼Ÿ`, 'å±é™©æ“ä½œ', {
                    type: 'warning'
                }).then(() => {
                    axios.delete(`/api/components/${this.currentPart.id}`).then(res => {
                        this.$message.success('åˆ é™¤æˆåŠŸ');
                        this.currentPart = null;
                        this.loadTree(); // é‡æ–°åŠ è½½æ ‘
                    });
                });
            }
        }
    })
</script>
</body>
</html>