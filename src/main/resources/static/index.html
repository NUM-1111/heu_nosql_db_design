<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>èˆ¹èˆ¶å·¥ç¨‹æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body { margin: 0; padding: 0; font-family: "Helvetica Neue",Helvetica,"PingFang SC",Arial,sans-serif; background: #f5f7fa; }
        .header { background-color: #409EFF; color: white; padding: 0 20px; height: 60px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,.12); }
        .container { display: flex; height: calc(100vh - 60px); }
        .aside { width: 340px; border-right: 1px solid #e6e6e6; background-color: #fff; display: flex; flex-direction: column; }
        .tree-toolbar { padding: 10px; border-bottom: 1px solid #eee; display: flex; gap: 5px; background: #fafafa; }
        .tree-wrapper { flex: 1; overflow-y: auto; padding: 10px; }
        .custom-tree-node { flex: 1; display: flex; align-items: center; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .main { flex: 1; padding: 30px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; }

        .search-bar { margin-bottom: 20px; padding: 15px; background: #f2f6fc; border-radius: 4px; display: flex; align-items: center; }
        .empty-tip { text-align: center; margin-top: 150px; color: #909399; }
        .json-box { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow: auto; }
        .kv-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .pagination-container { margin-top: 20px; text-align: right; }
    </style>
</head>
<body>
<div id="app">
    <div class="header">
        <div style="font-size: 20px; font-weight: bold;"><i class="el-icon-ship"></i> èˆ¹èˆ¶æ–‡æ¡£ç®¡ç† V6.1 </div>
        <div>
            <el-button type="text" style="color: white; margin-right: 10px;" icon="el-icon-s-home" @click="goDashboard">è¿”å›é©¾é©¶èˆ±</el-button>
            <el-tag effect="dark" type="warning" size="small">å½“å‰èˆ¹èˆ¶ ID: {{ shipId }}</el-tag>
        </div>
    </div>

    <div class="container">
        <div class="aside">
            <div class="tree-toolbar">
                <el-button type="primary" size="mini" icon="el-icon-refresh" circle @click="loadTree" title="åˆ·æ–°"></el-button>
                <el-button type="danger" size="mini" @click="initTree">é‡ç½®æµ‹è¯•æ•°æ®</el-button>
                <el-button type="info" size="mini" @click="viewAuditLogs">æ—¥å¿—</el-button>
            </div>
            <div class="tree-wrapper">
                <el-tree
                        :key="treeKey"
                        ref="tree" :data="treeData" :props="defaultProps" @node-click="handleNodeClick"
                        default-expand-all highlight-current node-key="id" draggable :allow-drop="allowDrop" @node-drop="handleDrop">
                    <span class="custom-tree-node" slot-scope="{ node, data }">
                        <span><i :class="getIcon(data.type)"></i> {{ node.label }}</span>
                    </span>
                </el-tree>
            </div>
        </div>

        <div class="main">
            <div class="search-bar">
                <span style="margin-right: 10px; font-weight: bold; color: #606266;">å…¨æ–‡æ£€ç´¢:</span>
                <el-input placeholder="è¾“å…¥æ–‡æ¡£æ ‡é¢˜å…³é”®è¯..." v-model="query.keyword" @keyup.enter.native="doSearch" clearable @clear="doSearch" style="width: 300px;">
                    <el-button slot="append" icon="el-icon-search" @click="doSearch"></el-button>
                </el-input>
            </div>

            <div v-if="currentPart || isSearching">
                <div v-if="!isSearching">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin:0 0 5px 0;"><i :class="getIcon(currentPart.type)"></i> {{ currentPart.name }}</h2>
                            <el-tag size="mini">{{ currentPart.type }}</el-tag>
                            <span style="color:#999;font-size:12px;margin-left:10px">ID: {{ currentPart.id }}</span>
                        </div>
                        <div>
                            <el-button type="primary" size="small" icon="el-icon-edit" @click="openDialog(currentPart, true)">ç¼–è¾‘éƒ¨ä»¶</el-button>
                            <el-button type="success" size="small" icon="el-icon-folder-add" @click="openDialog(currentPart, false)">åŠ å­é¡¹</el-button>
                            <el-button v-if="currentPart.type !== 'Ship'" type="danger" size="small" icon="el-icon-delete" @click="deletePart">åˆ é™¤</el-button>
                        </div>
                    </div>

                    <el-descriptions border :column="2" size="small" title="âš™ï¸ NoSQL åŠ¨æ€å‚æ•°">
                        <template v-if="currentPart.specs && Object.keys(currentPart.specs).length > 0">
                            <el-descriptions-item v-for="(val, key) in currentPart.specs" :key="key" :label="key">{{ val }}</el-descriptions-item>
                        </template>
                        <template v-else><el-descriptions-item label="çŠ¶æ€">æš‚æ— å‚æ•° (è¯·ç‚¹å‡»ç¼–è¾‘æ·»åŠ )</el-descriptions-item></template>
                    </el-descriptions>
                    <el-divider content-position="left">ğŸ“„ å…³è”æ–‡æ¡£</el-divider>

                    <div style="margin-bottom: 10px;">
                        <el-button type="primary" size="small" icon="el-icon-upload2" @click="openUploadDialog">ä¸Šä¼ æ–°æ–‡æ¡£</el-button>
                    </div>
                </div>

                <div v-if="isSearching || currentPart">
                    <el-table :data="docList" style="width: 100%" stripe v-loading="loading">
                        <el-table-column prop="title" label="æ–‡æ¡£æ ‡é¢˜" min-width="200"></el-table-column>
                        <el-table-column prop="category" label="åˆ†ç±»" width="150">
                            <template slot-scope="scope"><el-tag size="mini">{{ scope.row.category }}</el-tag></template>
                        </el-table-column>
                        <el-table-column prop="createdAt" label="æ—¶é—´" width="160">
                            <template slot-scope="scope">{{ formatDate(scope.row.createdAt) }}</template>
                        </el-table-column>
                        <el-table-column label="æ“ä½œ" width="180" align="center">
                            <template slot-scope="scope">
                                <el-button size="mini" type="text" icon="el-icon-edit" @click="openEditDocDialog(scope.row)">ç¼–è¾‘</el-button>
                                <el-button size="mini" type="text" icon="el-icon-view" @click="showDocDetail(scope.row.id)">è¯¦æƒ…/ä¸‹è½½</el-button>
                            </template>
                        </el-table-column>
                    </el-table>

                    <div class="pagination-container">
                        <el-pagination @size-change="handleSizeChange" @current-change="handlePageChange" :current-page="query.page" :page-sizes="[10, 20, 50]" :page-size="query.size" layout="total, sizes, prev, pager, next, jumper" :total="totalDocs"></el-pagination>
                    </div>
                </div>
            </div>

            <div v-else class="empty-tip">
                <i class="el-icon-s-unfold" style="font-size: 40px; color: #ddd;"></i><br>
                è¯·ç‚¹å‡»å·¦ä¾§æ ‘èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…<br>
                <span style="font-size: 12px; color: #ccc;">(æ ¹èŠ‚ç‚¹å·²è‡ªåŠ¨ç”Ÿæˆ)</span>
            </div>
        </div>
    </div>

    <el-dialog :title="dialogTitle" :visible.sync="dialogVisible" width="500px">
        <el-form :model="form" label-width="80px">
            <el-form-item label="åç§°" required><el-input v-model="form.name"></el-input></el-form-item>
            <el-form-item label="ç±»å‹" required>
                <el-select v-model="form.type" style="width: 100%"><el-option v-for="t in types" :key="t" :label="t" :value="t"></el-option></el-select>
            </el-form-item>
            <div style="background: #f4f4f5; padding: 10px; border-radius: 4px;">
                <div style="margin-bottom: 10px; font-size: 12px; color: #909399;">åŠ¨æ€å‚æ•° (Specs)</div>
                <div v-for="(item, index) in form.kvList" :key="index" class="kv-row">
                    <el-input v-model="item.key" placeholder="Key" size="small"></el-input>
                    <el-input v-model="item.val" placeholder="Value" size="small"></el-input>
                    <el-button type="danger" icon="el-icon-close" circle size="mini" @click="removeKv(index)"></el-button>
                </div>
                <el-button type="text" icon="el-icon-plus" size="mini" @click="addKv">æ·»åŠ å‚æ•°</el-button>
            </div>
        </el-form>
        <div slot="footer"><el-button @click="dialogVisible = false">å–æ¶ˆ</el-button><el-button type="primary" @click="submitForm">ç¡®å®š</el-button></div>
    </el-dialog>

    <el-dialog title="ä¸Šä¼ æ–‡æ¡£" :visible.sync="uploadVisible" width="500px">
        <el-form label-width="80px">
            <el-form-item label="æ‰€å±éƒ¨ä»¶"><el-input :value="currentPart ? currentPart.name : ''" disabled></el-input></el-form-item>
            <el-form-item label="æ–‡æ¡£åˆ†ç±»" required>
                <el-select v-model="uploadForm.category" style="width: 100%"><el-option v-for="c in categories" :key="c" :label="c" :value="c"></el-option></el-select>
            </el-form-item>
            <el-form-item label="é€‰æ‹©æ–‡ä»¶" required><input type="file" ref="fileInput" @change="handleFileChange"></el-form-item>
        </el-form>
        <div slot="footer"><el-button @click="uploadVisible = false">å–æ¶ˆ</el-button><el-button type="primary" @click="submitUpload" :loading="uploading">å¼€å§‹ä¸Šä¼ </el-button></div>
    </el-dialog>

    <el-dialog title="ä¿®æ”¹æ–‡æ¡£ä¿¡æ¯" :visible.sync="editDocVisible" width="500px">
        <el-form label-width="80px">
            <el-form-item label="æ ‡é¢˜" required><el-input v-model="editDocForm.title"></el-input></el-form-item>
            <el-form-item label="åˆ†ç±»" required>
                <el-select v-model="editDocForm.category" style="width: 100%"><el-option v-for="c in categories" :key="c" :label="c" :value="c"></el-option></el-select>
            </el-form-item>
        </el-form>
        <div slot="footer"><el-button @click="editDocVisible = false">å–æ¶ˆ</el-button><el-button type="primary" @click="submitDocEdit">ä¿å­˜</el-button></div>
    </el-dialog>

    <el-dialog title="æ–‡æ¡£å…¨æ¯è§†å›¾" :visible.sync="docDialogVisible" width="600px">
        <div v-if="currentDocDetail">
            <div class="json-box">{{ currentDocDetail.metadata ? JSON.stringify(currentDocDetail.metadata, null, 2) : '{}' }}</div>
            <div v-for="(v, index) in currentDocDetail.versions" :key="index" style="padding: 10px; border-bottom: 1px solid #eee;">
                <span style="font-weight: bold;">{{ v.versionNo }}</span> <span style="font-size: 12px;">{{ (v.fileSize/1024).toFixed(1) }} KB</span>
                <el-link type="primary" :href="v.downloadUrl" target="_blank" style="float: right;">åœ¨çº¿é¢„è§ˆ</el-link>
            </div>
        </div>
    </el-dialog>
</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            treeKey: 0, // å¼ºåˆ¶åˆ·æ–°æ ‘çš„ Key
            treeData: [], defaultProps: { children: 'children', label: 'name' },
            currentPart: null, docList: [], types: ['System', 'Engine', 'Pump', 'Valve', 'Other'],
            categories: ["Manual (æ‰‹å†Œ)", "Drawing (å›¾çº¸)", "Contract (åˆåŒ)", "Report (æŠ¥å‘Š)", "Certificate (è¯ä¹¦)", "Other (å…¶ä»–)"],
            loading: false, isSearching: false, totalDocs: 0, query: { page: 1, size: 10, keyword: '' },
            dialogVisible: false, dialogTitle: '', isEditMode: false, form: { id: null, name: '', type: '', parentId: null, kvList: [] },
            uploadVisible: false, uploading: false, uploadForm: { category: '', file: null },
            editDocVisible: false, editDocForm: { id: null, title: '', category: '' },
            docDialogVisible: false, currentDocDetail: null,
            shipId: new URLSearchParams(window.location.search).get('shipId') || 888
        },
        mounted() { this.loadTree(); },
        methods: {
            goDashboard() { window.location.href = 'dashboard.html'; },
            getIcon(type) { const m = { 'Ship': 'el-icon-ship', 'System': 'el-icon-cpu', 'Engine': 'el-icon-odometer' }; return m[type] || 'el-icon-setting'; },
            formatDate(str) { return str ? str.replace('T', ' ').split('.')[0] : ''; },
            loadTree() {
                axios.get(`/api/components/tree?shipId=${this.shipId}`).then(res => {
                    this.treeData = res.data;
                    this.treeKey++; // æ¯æ¬¡åŠ è½½æ•°æ®ï¼Œå¼ºåˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“ (è§£å†³å­èŠ‚ç‚¹ä¸æ˜¾ç¤ºé—®é¢˜)
                });
            },
            loadDocs() {
                this.loading = true;
                const params = { shipId: this.shipId, page: this.query.page, size: this.query.size, keyword: this.query.keyword };
                if (!this.isSearching && this.currentPart) params.componentId = this.currentPart.id;
                axios.get('/api/docs/list', { params }).then(res => { this.docList = res.data.records; this.totalDocs = res.data.total; this.loading = false; }).catch(() => this.loading = false);
            },
            doSearch() { this.query.page = 1; if(!this.query.keyword) { this.isSearching = false; if(this.currentPart) this.loadDocs(); return; } this.isSearching = true; this.currentPart = null; this.$refs.tree.setCurrentKey(null); this.loadDocs(); },
            handleSizeChange(val) { this.query.size = val; this.loadDocs(); },
            handlePageChange(val) { this.query.page = val; this.loadDocs(); },
            handleNodeClick(data) { this.isSearching = false; this.query.keyword = ''; this.query.page = 1; this.currentPart = data; this.loadDocs(); },
            openUploadDialog() { this.uploadForm = { category: '', file: null }; this.uploadVisible = true; if(this.$refs.fileInput) this.$refs.fileInput.value = ''; },
            handleFileChange(e) { this.uploadForm.file = e.target.files[0]; },
            submitUpload() {
                if(!this.uploadForm.file || !this.uploadForm.category) { this.$message.warning('è¯·å¡«å†™å®Œæ•´'); return; }
                let d = new FormData(); d.append('file', this.uploadForm.file); d.append('shipId', this.shipId); d.append('componentId', this.currentPart.id); d.append('title', this.uploadForm.file.name); d.append('category', this.uploadForm.category);
                this.uploading = true; axios.post('/api/docs/upload', d).then(() => { this.uploading = false; this.uploadVisible = false; this.$message.success('ä¸Šä¼ æˆåŠŸ'); this.loadDocs(); }).catch(() => { this.uploading = false; this.$message.error('å¤±è´¥'); });
            },
            openEditDocDialog(row) { this.editDocForm = { id: row.id, title: row.title, category: row.category }; this.editDocVisible = true; },
            submitDocEdit() { axios.put(`/api/docs/${this.editDocForm.id}`, this.editDocForm).then(() => { this.$message.success('ä¿®æ”¹æˆåŠŸ'); this.editDocVisible = false; this.loadDocs(); }); },
            showDocDetail(id) { axios.get(`/api/docs/${id}`).then(res => { this.currentDocDetail = res.data; this.docDialogVisible = true; }); },
            viewAuditLogs() { this.$alert('è¯·å‰å¾€ Mongo Express (localhost:8081) æŸ¥çœ‹æ—¥å¿—', 'å®¡è®¡'); },
            allowDrop(n, d, t) { return true; },
            handleDrop(n, d, t) {
                let pid = (t === 'inner') ? d.data.id : d.data.parentId;
                axios.put(`/api/components/${n.data.id}/move`, null, { params: { newParentId: pid || 'root' } }).then(() => { this.$message.success('ç§»åŠ¨æˆåŠŸ'); this.loadTree(); });
            },
            openDialog(node, isEdit) {
                this.isEditMode = isEdit; this.form.kvList = [];
                // æ ¡éªŒï¼šå¦‚æœæ˜¯æ–°å¢ï¼Œå¿…é¡»é€‰ä¸­çˆ¶èŠ‚ç‚¹ï¼ˆå› ä¸ºæ ¹èŠ‚ç‚¹æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼‰
                if (!isEdit && !node) { this.$message.warning('è¯·åœ¨å·¦ä¾§é€‰ä¸­çˆ¶èŠ‚ç‚¹åï¼Œå†æ·»åŠ å­é¡¹'); return; }

                if (isEdit) {
                    this.dialogTitle = `ç¼–è¾‘: ${node.name}`;
                    this.form.id = node.id; this.form.name = node.name; this.form.type = node.type;
                    if(node.specs) for(let k in node.specs) this.form.kvList.push({key:k, val:node.specs[k]});
                } else {
                    this.dialogTitle = `æ–°å¢ [${node.name}] çš„å­éƒ¨ä»¶`;
                    this.form.id = null; this.form.name = ''; this.form.type = '';
                    this.form.parentId = node.id; // ğŸ‘ˆ å…³é”®ä¿®å¤ï¼šç¡®ä¿ä¼ äº†çˆ¶ID
                }
                this.dialogVisible = true;
            },
            addKv() { this.form.kvList.push({ key: '', val: '' }); },
            removeKv(index) { this.form.kvList.splice(index, 1); },
            submitForm() {
                let specs = {}; this.form.kvList.forEach(i => { if(i.key) specs[i.key] = i.val });
                let payload = { shipId: this.shipId, name: this.form.name, type: this.form.type, specs: specs, parentId: this.form.parentId };
                let req = this.isEditMode ? axios.put(`/api/components/${this.form.id}`, payload) : axios.post('/api/components', payload);
                req.then(() => {
                    this.$message.success('æˆåŠŸ');
                    this.dialogVisible = false;
                    this.loadTree();
                    // ç¼–è¾‘åç®€å•åˆ·æ–°å½“å‰è§†å›¾
                    if(this.isEditMode && this.currentPart) {
                        this.currentPart.name = this.form.name;
                        this.currentPart.type = this.form.type;
                        this.currentPart.specs = specs;
                    }
                });
            },
            initTree() { this.$confirm('ç¡®å®šé‡ç½®æµ‹è¯•æ•°æ®ï¼Ÿ').then(() => axios.get('/test/tree').then(res => { this.treeData = res.data; this.loadTree(); })); },
            deletePart() { this.$confirm('åˆ é™¤ï¼Ÿ').then(() => axios.delete(`/api/components/${this.currentPart.id}`).then(() => { this.$message.success('å·²åˆ é™¤'); this.currentPart = null; this.loadTree(); })); }
        }
    })
</script>
</body>
</html>