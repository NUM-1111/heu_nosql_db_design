<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>èˆ¹èˆ¶å·¥ç¨‹æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body { margin: 0; padding: 0; font-family: "Helvetica Neue",Helvetica,"PingFang SC",Arial,sans-serif; background: #f5f7fa; }
        .header { background-color: #409EFF; color: white; padding: 0 20px; height: 60px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,.12); }
        .container { display: flex; height: calc(100vh - 60px); }

        /* å·¦ä¾§æ ‘ */
        .aside { width: 340px; border-right: 1px solid #e6e6e6; background-color: #fff; display: flex; flex-direction: column; }
        .tree-toolbar { padding: 10px; border-bottom: 1px solid #eee; display: flex; gap: 5px; background: #fafafa; }
        .tree-wrapper { flex: 1; overflow-y: auto; padding: 10px; }
        .custom-tree-node { flex: 1; display: flex; align-items: center; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* å³ä¾§ä¸»å†…å®¹ */
        .main { flex: 1; padding: 30px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; }
        .search-bar { margin-bottom: 20px; display: flex; gap: 10px; }

        .empty-tip { text-align: center; margin-top: 150px; color: #909399; }
        .json-box { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow: auto; }
        .kv-row { display: flex; gap: 10px; margin-bottom: 8px; }
    </style>
</head>
<body>
<div id="app">
    <div class="header">
        <div style="font-size: 20px; font-weight: bold;"><i class="el-icon-ship"></i> èˆ¹èˆ¶æ–‡æ¡£ç®¡ç† V4.0</div>
        <el-tag effect="dark" type="warning" size="small">ID: {{ shipId }}</el-tag>
    </div>

    <div class="container">
        <div class="aside">
            <div class="tree-toolbar">
                <el-button type="primary" size="mini" icon="el-icon-refresh" circle @click="loadTree" title="åˆ·æ–°"></el-button>
                <el-button type="success" size="mini" icon="el-icon-plus" @click="openDialog(null)">æ ¹èŠ‚ç‚¹</el-button>
                <el-button type="danger" size="mini" @click="initTree">é‡ç½®</el-button>
                <el-button type="info" size="mini" icon="el-icon-notebook-1" @click="viewAuditLogs">æ—¥å¿—</el-button>
            </div>
            <div class="tree-wrapper">
                <el-tree
                        ref="tree"
                        :data="treeData"
                        :props="defaultProps"
                        @node-click="handleNodeClick"
                        default-expand-all
                        highlight-current
                        node-key="id"
                        draggable
                        :allow-drop="allowDrop"
                        @node-drop="handleDrop">
                    <span class="custom-tree-node" slot-scope="{ node, data }">
                        <span><i :class="getIcon(data.type)"></i> {{ node.label }}</span>
                    </span>
                </el-tree>
            </div>
        </div>

        <div class="main">
            <div class="search-bar">
                <el-input placeholder="å…¨ç«™æœç´¢æ–‡æ¡£ (è¾“å…¥æ ‡é¢˜...)" v-model="searchKeyword" @keyup.enter.native="doSearch" clearable @clear="doSearch" prefix-icon="el-icon-search">
                    <el-button slot="append" @click="doSearch">æœç´¢</el-button>
                </el-input>
            </div>

            <div v-if="currentPart || isSearching">
                <div v-if="isSearching">
                    <h3>ğŸ” æœç´¢ç»“æœ: "{{ searchKeyword }}"</h3>
                    <el-table :data="docList" border stripe>
                        <el-table-column prop="title" label="æ–‡æ¡£æ ‡é¢˜"></el-table-column>
                        <el-table-column prop="category" label="åˆ†ç±»" width="120"></el-table-column>
                        <el-table-column label="è¯¦æƒ…" width="120" align="center">
                            <template slot-scope="scope"><el-button size="mini" @click="showDocDetail(scope.row.id)">æŸ¥çœ‹</el-button></template>
                        </el-table-column>
                    </el-table>
                </div>

                <div v-else>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin:0 0 5px 0;"><i :class="getIcon(currentPart.type)"></i> {{ currentPart.name }}</h2>
                            <el-tag size="mini">{{ currentPart.type }}</el-tag> <span style="color:#999;font-size:12px">ID: {{ currentPart.id }}</span>
                        </div>
                        <div>
                            <el-button type="primary" size="small" icon="el-icon-edit" @click="openDialog(currentPart, true)">ç¼–è¾‘</el-button>
                            <el-button type="success" size="small" icon="el-icon-folder-add" @click="openDialog(currentPart, false)">åŠ å­é¡¹</el-button>
                            <el-button type="danger" size="small" icon="el-icon-delete" @click="deletePart">åˆ é™¤</el-button>
                        </div>
                    </div>

                    <el-descriptions border :column="2" size="small" title="NoSQL åŠ¨æ€å‚æ•°">
                        <template v-if="currentPart.specs && Object.keys(currentPart.specs).length > 0">
                            <el-descriptions-item v-for="(val, key) in currentPart.specs" :key="key" :label="key">{{ val }}</el-descriptions-item>
                        </template>
                        <template v-else><el-descriptions-item label="çŠ¶æ€">æš‚æ— å‚æ•°</el-descriptions-item></template>
                    </el-descriptions>

                    <el-divider content-position="left">å…³è”æ–‡æ¡£</el-divider>

                    <div style="margin-bottom: 10px;">
                        <input type="file" ref="fileInput" style="display: none" @change="uploadFile">
                        <el-button type="primary" size="small" plain icon="el-icon-upload2" @click="$refs.fileInput.click()">ä¸Šä¼ æ–‡æ¡£</el-button>
                    </div>

                    <el-table :data="docList" style="width: 100%" stripe>
                        <el-table-column prop="title" label="æ–‡æ¡£æ ‡é¢˜"></el-table-column>
                        <el-table-column prop="category" label="åˆ†ç±»" width="120">
                            <template slot-scope="scope"><el-tag size="mini">{{ scope.row.category }}</el-tag></template>
                        </el-table-column>
                        <el-table-column prop="createdAt" label="æ—¶é—´" width="160">
                            <template slot-scope="scope">{{ formatDate(scope.row.createdAt) }}</template>
                        </el-table-column>
                        <el-table-column label="æ“ä½œ" width="100" align="center">
                            <template slot-scope="scope">
                                <el-button size="mini" type="text" @click="showDocDetail(scope.row.id)">è¯¦æƒ…/é¢„è§ˆ</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
            </div>
            <div v-else class="empty-tip">
                <i class="el-icon-top-left" style="font-size: 30px;"></i><br>
                è¯·é€‰æ‹©å·¦ä¾§èŠ‚ç‚¹æˆ–è¿›è¡Œæœç´¢
            </div>
        </div>
    </div>

    <el-dialog :title="dialogTitle" :visible.sync="dialogVisible" width="500px">
        <el-form :model="form" label-width="80px">
            <el-form-item label="åç§°" required><el-input v-model="form.name"></el-input></el-form-item>
            <el-form-item label="ç±»å‹" required>
                <el-select v-model="form.type" style="width: 100%"><el-option v-for="t in types" :key="t" :label="t" :value="t"></el-option></el-select>
            </el-form-item>
            <div style="background: #f4f4f5; padding: 10px; border-radius: 4px;">
                <div style="font-size: 12px; color: #909399; margin-bottom: 5px;">åŠ¨æ€å‚æ•° (Specs)</div>
                <div v-for="(item, index) in form.kvList" :key="index" class="kv-row">
                    <el-input v-model="item.key" placeholder="Key" size="small"></el-input>
                    <el-input v-model="item.val" placeholder="Value" size="small"></el-input>
                    <el-button type="danger" icon="el-icon-close" circle size="mini" @click="removeKv(index)"></el-button>
                </div>
                <el-button type="text" icon="el-icon-plus" size="mini" @click="addKv">æ·»åŠ å‚æ•°</el-button>
            </div>
        </el-form>
        <div slot="footer"><el-button @click="dialogVisible = false">å–æ¶ˆ</el-button><el-button type="primary" @click="submitForm">ç¡®å®š</el-button></div>
    </el-dialog>

    <el-dialog title="æ–‡æ¡£å…¨æ¯è§†å›¾" :visible.sync="docDialogVisible" width="600px">
        <div v-if="currentDocDetail">
            <el-alert title="NoSQL ä¼˜åŠ¿: çµæ´»å­˜å‚¨å…ƒæ•°æ®ä¸å†…åµŒç‰ˆæœ¬" type="info" :closable="false" style="margin-bottom:10px"></el-alert>
            <div class="json-box">{{ currentDocDetail.metadata ? JSON.stringify(currentDocDetail.metadata, null, 2) : '{}' }}</div>
            <h4 style="margin: 15px 0 5px;">ç‰ˆæœ¬å†å²</h4>
            <div v-for="(v, index) in currentDocDetail.versions" :key="index" style="padding: 10px; border-bottom: 1px solid #eee;">
                <span style="font-weight: bold;">{{ v.versionNo }}</span>
                <span style="font-size: 12px; margin-left: 10px;">{{ (v.fileSize/1024).toFixed(1) }} KB</span>
                <el-link type="primary" :href="v.downloadUrl" target="_blank" style="float: right;">åœ¨çº¿é¢„è§ˆ / ä¸‹è½½</el-link>
            </div>
        </div>
    </el-dialog>
</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            treeData: [], defaultProps: { children: 'children', label: 'name' },
            currentPart: null, docList: [], shipId: 888, types: ['Ship', 'System', 'Engine', 'Pump', 'Valve', 'Other'],
            searchKeyword: '', isSearching: false,
            dialogVisible: false, dialogTitle: '', isEditMode: false, form: { id: null, name: '', type: '', parentId: null, kvList: [] },
            docDialogVisible: false, currentDocDetail: null
        },
        mounted() { this.loadTree(); },
        methods: {
            getIcon(type) { const m = { 'Ship': 'el-icon-ship', 'System': 'el-icon-cpu', 'Engine': 'el-icon-odometer' }; return m[type] || 'el-icon-setting'; },
            formatDate(str) { return str ? str.replace('T', ' ').split('.')[0] : ''; },
            loadTree() { axios.get(`/api/components/tree?shipId=${this.shipId}`).then(res => this.treeData = res.data); },

            // --- æ‹–æ‹½é€»è¾‘ä¿®å¤ ---
            allowDrop(draggingNode, dropNode, type) {
                // ã€ä¿®å¤ã€‘å…è®¸æ‰€æœ‰ä½ç½® (inner=æ”¾å…¥, prev=æ’å‰, next=æ’å)
                // åªæœ‰è¿™æ ·ï¼ŒElement UI æ‰ä¼šæ˜¾ç¤ºé‚£ä¸ªè“è‰²çš„æ¨ªçº¿(shadow)
                return true;
            },
            handleDrop(draggingNode, dropNode, dropType, ev) {
                let newParentId = null;
                if (dropType === 'inner') {
                    // æ”¾å…¥æŸèŠ‚ç‚¹å†…éƒ¨ï¼Œçˆ¶èŠ‚ç‚¹å°±æ˜¯å®ƒ
                    newParentId = dropNode.data.id;
                } else {
                    // æ”¾å…¥æŸèŠ‚ç‚¹å‰å (prev/next)ï¼Œçˆ¶èŠ‚ç‚¹å°±æ˜¯é‚£ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹
                    newParentId = dropNode.data.parentId;
                }

                // å¦‚æœ newParentId ä¸º nullï¼Œè¯´æ˜æ‹–åˆ°äº†æ ¹å±‚çº§ï¼Œä¼  'root' ç»™åç«¯
                const targetId = newParentId || 'root';

                axios.put(`/api/components/${draggingNode.data.id}/move`, null, { params: { newParentId: targetId } })
                    .then(() => {
                        this.$message.success('ç§»åŠ¨æˆåŠŸ');
                        this.loadTree(); // å¿…é¡»åˆ·æ–°ï¼Œç¡®ä¿ ancestors æ­£ç¡®
                    });
            },

            // æœç´¢
            doSearch() {
                if(!this.searchKeyword) { this.isSearching = false; if(this.currentPart) this.loadDocs(this.currentPart.id); return; }
                this.isSearching = true; this.currentPart = null; this.$refs.tree.setCurrentKey(null);
                axios.get(`/api/docs/list`, { params: { shipId: this.shipId, keyword: this.searchKeyword } })
                    .then(res => this.docList = res.data);
            },

            // å…¶ä»–é€»è¾‘
            handleNodeClick(data) { this.isSearching = false; this.searchKeyword = ''; this.currentPart = data; this.loadDocs(data.id); },
            loadDocs(id) { axios.get(`/api/docs/list?shipId=${this.shipId}&componentId=${id}`).then(res => this.docList = res.data); },
            showDocDetail(id) { axios.get(`/api/docs/${id}`).then(res => { this.currentDocDetail = res.data; this.docDialogVisible = true; }); },

            // å®¡è®¡æ—¥å¿—å…¥å£ (ç®€å•å¼¹çª—æç¤º)
            viewAuditLogs() {
                this.$alert('è¯·å‰å¾€ Mongo Express (http://localhost:8081) æŸ¥çœ‹ system_audit_logs é›†åˆã€‚', 'å®¡è®¡æ—¥å¿—', { confirmButtonText: 'çŸ¥é“äº†' });
            },

            // å¢åˆ æ”¹
            openDialog(node, isEdit) {
                this.isEditMode = isEdit; this.form.kvList = [];
                if (isEdit) {
                    this.dialogTitle = `ç¼–è¾‘: ${node.name}`; this.form.id = node.id; this.form.name = node.name; this.form.type = node.type;
                    if(node.specs) for(let k in node.specs) this.form.kvList.push({key:k, val:node.specs[k]});
                } else {
                    this.dialogTitle = node ? `æ–°å¢å­èŠ‚ç‚¹` : 'æ–°å¢æ ¹èŠ‚ç‚¹'; this.form.id = null; this.form.name = ''; this.form.type = ''; this.form.parentId = node ? node.id : null;
                }
                this.dialogVisible = true;
            },
            addKv() { this.form.kvList.push({ key: '', val: '' }); },
            removeKv(index) { this.form.kvList.splice(index, 1); },
            submitForm() {
                let specs = {}; this.form.kvList.forEach(i => { if(i.key) specs[i.key] = i.val });
                let payload = { shipId: this.shipId, name: this.form.name, type: this.form.type, specs: specs, parentId: this.form.parentId };
                let req = this.isEditMode ? axios.put(`/api/components/${this.form.id}`, payload) : axios.post('/api/components', payload);
                req.then(() => { this.$message.success('æˆåŠŸ'); this.dialogVisible = false; this.loadTree();
                    if(this.isEditMode && this.currentPart) { this.currentPart.name = this.form.name; this.currentPart.specs = specs; } // ç®€å•åˆ·æ–°ç•Œé¢
                });
            },
            initTree() { this.$confirm('é‡ç½®ï¼Ÿ').then(() => axios.get('/test/tree').then(res => { this.treeData = res.data; this.loadTree(); })); },
            deletePart() { this.$confirm('åˆ é™¤ï¼Ÿ').then(() => axios.delete(`/api/components/${this.currentPart.id}`).then(() => { this.$message.success('å·²åˆ é™¤'); this.currentPart = null; this.loadTree(); })); },
            uploadFile(e) {
                let f = e.target.files[0]; if(!f) return;
                let d = new FormData(); d.append('file', f); d.append('shipId', this.shipId); d.append('componentId', this.currentPart.id); d.append('title', f.name); d.append('category', 'Manual');
                const l = this.$loading(); axios.post('/api/docs/upload', d).then(() => { l.close(); this.$message.success('æˆåŠŸ'); this.loadDocs(this.currentPart.id); }).catch(()=>l.close());
            }
        }
    })
</script>
</body>
</html>